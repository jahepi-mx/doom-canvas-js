<html>

<head>
<title>Doom canvas js</title>
<meta charset="UTF-8">
<script src="vector.js"></script>
<script src="line.js"></script>
<script src="sector.js"></script>
<script src="player.js"></script>
<script>
var w = 500;
var h = 500;
var hw = w * 0.5;
var hh = h * 0.5;
var canvas = null;
var context = null;
var localCanvas = null;
var localContext = null;
var canvas3d = null;
var context3d = null;
var lastTime = 0;
var player = null;
var lines = [];
var width3d = 300;
var height3d = 300;
var hw3d = width3d * 0.5;
var hh3d = height3d * 0.5;
var image = null;
var zCam = 0;
var zCamOffset = 100;

//Perpective
var tan = 0;
var camZOffset = new Vector(0, 0);
var camUp = camDown = false;
var yBuffer = [];

var sectors = [];

window.onload = function() {
    canvas = document.getElementById("canvas");
    context = canvas.getContext("2d");
    canvas.width = w;
    canvas.height = h;
    localCanvas = document.getElementById("localCanvas");
    localContext = localCanvas.getContext("2d");
    localCanvas.width = w;
    localCanvas.height = h;
    canvas3d = document.getElementById("3dCanvas");
    context3d = canvas3d.getContext("2d");
    canvas3d.width = width3d;
    canvas3d.height = height3d;
    player = new Player(hw, hh);

    var canvas = document.getElementById("floorCanvas");
    var floorContext = document.getElementById("floorCanvas").getContext("2d");
    floorContext.drawImage(document.getElementById("floor"), 0, 0);
    var floorImgData = floorContext.getImageData(0, 0, canvas.width, canvas.height);

    tan = 1 / Math.tan(player.fovDegrees * player.toRadians);
    camZOffset.z = zCamOffset;

    var sector = new Sector(player, camZOffset, 0, 300, tan, hw3d, hh3d, hw, hh, 0);
    sector.add(-300, 150, -250, 200, "yellow", 0, 0, true);
    sector.add(-250, 200, 250, 200, "cyan", 0, 0, true);
    sector.add(250, 200, 300, 150, "red", 0, 0, true);
    sector.add(300, 150, 300, -150, "brown", 120, 0, false);
    sector.add(300, -150, 250, -200, "green", 0, 0, true);
    sector.add(250, -200, -250, -200, "pink", 0, 0, true);
    sector.add(-250, -200, -300, -150, "white", 0, 0, true);
    sector.add(-300, -150, -300, 150, "orange", 0, 0, true);
    sector.loadFloorCeilingTextureData(floorImgData);
    sectors.push(sector);

    sector = new Sector(player, camZOffset, 0, 40, tan, hw3d, hh3d, hw, hh, 20);
    sector.add(180, 20, 200, 40, "yellow", 0, 0, false);
    sector.add(200, 40, 220, 40, "cyan", 0, 0, false);
    sector.add(220, 40, 220, -40, "red", 0, 0, false);
    sector.add(220, -40, 200, -40, "brown", 0, 0, false);
    sector.add(200, -40, 180, -20, "green", 0, 0, false);
    sector.add(180, -20, 180, 20, "pink", 0, 0, false);
    sector.hasFloor = false;
    sector.loadFloorCeilingTextureData(floorImgData);
    sectors.push(sector);

    sector = new Sector(player, camZOffset, 0, 80, tan, hw3d, hh3d, hw, hh, 50);
    sector.add(220, 60, 260, 60, "yellow", 0, 0, false);
    sector.add(260, 60, 260, -60, "cyan", 0, 0, false);
    sector.add(260, -60, 220, -60, "red", 0, 0, false);
    sector.add(220, -60, 220, 60, "brown", 0, 0, false);
    sector.hasFloor = false;
    sector.loadFloorCeilingTextureData(floorImgData);
    sectors.push(sector);

    sector = new Sector(player, camZOffset, 0, 120, tan, hw3d, hh3d, hw, hh, 70);
    sector.add(260, 80, 300, 80, "yellow", 0, 0, false);
    sector.add(300, 80, 300, -80, "cyan", 0, 0, false);
    sector.add(300, -80, 260, -80, "red", 0, 0, false);
    sector.add(260, -80, 260, 80, "brown", 0, 0, false);
    sector.hasFloor = false;
    sector.loadFloorCeilingTextureData(floorImgData);
    sectors.push(sector);

    sector = new Sector(player, camZOffset, 120, 180, tan, hw3d, hh3d, hw, hh, 70);
    sector.add(300, 150, 650, 150, "yellow", 0, 0, true);
    sector.add(650, 150, 650, -150, "cyan", 20, 0, false);
    sector.add(650, -150, 300, -150, "red", 0, 0, true);
    sector.add(300, -150, 300, 150, "brown", 0, 20, false);
    sector.loadFloorCeilingTextureData(floorImgData);
    sectors.push(sector);

    image = new Image(50, 50);
    image.onload = onLoadImage;
    image.src = "wall.png";

    document.onkeydown = onKeyDown;
    document.onkeyup = onKeyUp;
}

function onLoadImage() {
    render();
}
        
function onKeyDown(key) {
    switch(key.keyCode) {
        case 65: player.left = true; break;
        case 68: player.right = true; break;
        case 87: player.up = true; break;
        case 38: camUp = true; break;
        case 40: camDown = true; break;
    }
}

function onKeyUp(key) {
    switch(key.keyCode) {
        case 65: player.left = false; break;
        case 68: player.right = false; break;
        case 87: player.up = false; break;
        case 38: camUp = false; break;
        case 40: camDown = false; break;
    }
}

function render(time) {
    var dt = (time - lastTime) / 1000;
    var fps = 1 / dt;
    //console.log(fps);
    context.imageSmoothingEnabled = false;
    context.clearRect(0, 0, w, h);
    localContext.imageSmoothingEnabled = false;
    localContext.clearRect(0, 0, w, h);
    context3d.imageSmoothingEnabled = false;
    context3d.clearRect(0, 0, width3d, height3d);
    lastTime = time;

    if (fps < 3) {
        //requestAnimationFrame(render);
        //return;
    }

    //camZOffset.z += camUp ? 50 * dt : 0;
    //camZOffset.z += camDown ? -50 * dt : 0;
    camZOffset.z = zCamOffset + zCam;

    player.update(dt);
    player.render(context);
    player.localRender(localContext);
    yBuffer = [];

    var canMove = true;
    zCam = 0;
    for (let sector of sectors) {
        sector.update(dt);
        sector.render(yBuffer, context, localContext);
        canMove = canMove && !sector.collided;
        zCam = sector.isInside ? Math.max(zCam, sector.zCam) : zCam;
    }
    player.canMove = canMove;
    //console.log(yBuffer.length);
    yBuffer.sort((a, b) => b.order - a.order);
    for (let obj of yBuffer) {
        if (obj.img == 1) {
            context3d.drawImage(image, obj.texratio * image.width, 0, 1, image.height, hw3d + obj.x, hh3d - obj.z, obj.width, obj.height)
            context3d.fillStyle = "rgba(0,0,0," + (obj.order / 800) + ")";
            context3d.fillRect(hw3d + obj.x, hh3d - obj.z, obj.width, obj.height);
        } else {
            for (let data of obj.data) {
                context3d.fillStyle = data.color;
                context3d.fillRect(hw3d + data.x, hh3d - data.z, data.width, data.height);
            }
        }
    }

    context3d.font = "14px Arial";
    context3d.fillStyle = "#74ff33";
    context3d.fillText(parseInt(fps), width3d - 20, 20);

    requestAnimationFrame(render);
}
</script>

</head>
<body>

<canvas id="canvas" style="background-color: black;"></canvas>
<canvas id="localCanvas" style="background-color: black;"></canvas>
<canvas id="3dCanvas" style="background-color: #87ceeb;"></canvas>

<img id="floor" src="floor.png" width="50" height="50" style="display: none;">
<canvas id="floorCanvas" width="50" height="50" style="display: none;"></canvas>

</canvas>
</body>
</html>